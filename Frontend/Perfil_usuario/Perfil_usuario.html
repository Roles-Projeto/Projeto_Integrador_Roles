<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usu√°rio</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/Perfil_usuario.css">
</head>

<body>
    <header>
        <iframe id="site-header" src="../header/header.html" frameborder="0" scrolling="no" width="100%" height="200"
            style="position: fixed; top: 0; left: 0; z-index: 999999999;"></iframe>
    </header>

    <main class="profile-container">
        
        <div class="main-profile-card">
            
            <aside class="profile-sidebar">
                
                <div class="profile-info-content">

                    <div class="profile-picture-container">
                        <img src="https://i.imgur.com/default-placeholder.png" alt="Foto de Perfil" class="profile-picture">
                        <button id="edit-picture-btn" class="edit-picture-btn" title="Editar Foto de Perfil">
                            <i class="fas fa-camera"></i>
                        </button>
                        <input type="file" id="picture-upload" accept="image/*" style="display: none;">
                    </div>

                    <h2 class="profile-name"></h2> 
                    <span class="profile-badge">Cliente</span>

                    <p class="profile-detail" id="profile-email-display"></p>
                    <p class="profile-detail" id="profile-phone-display">(62) 99999-9999</p>
                    <p class="profile-detail">Goi√¢nia - GO</p>
                    <p class="profile-detail member-since">Membro desde Jan 2026</p>

                    <button id="edit-profile-btn" class="action-btn edit-btn">Editar Perfil</button>
                    <button class="action-btn logout-btn">Sair</button>
                </div>
                
            </aside>

            <section class="profile-content">

                <div id="edit-profile-section" class="content-section edit-profile-form-container hidden">
                    <h3>Editar Perfil</h3>
                    <form class="edit-profile-form" id="editProfileForm"> 
                        <div class="form-group">
                            <label for="nome">Nome</label>
                            <input type="text" id="nome" value="">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="">
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="tel" id="telefone" value="(62) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label for="senha">Senha</label>
                            <input type="password" id="senha" value="********">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="save-btn">Salvar</button>
                            <button type="button" id="cancel-edit-btn" class="cancel-btn">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div id="lists-section" class="content-sections-wrapper">
                    
                    <div class="content-section favorites-list">
                        <h3><i class="fas fa-heart"></i> Lugares Favoritos</h3>
                        <ul class="place-list">
                            <li class="place-item">
                                <span class="place-name">Bar do Jo√£o</span>
                                <span class="place-category">Bar</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.6
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Restaurante Villa</span>
                                <span class="place-category">Restaurante</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.8
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Club Manhattan</span>
                                <span class="place-category">Restaurante</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.9
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="content-section recent-visits-list">
                        <h3>Visitas Recentes</h3>
                        <ul class="place-list">
                            <li class="place-item">
                                <span class="place-name">Pizzaria Bella</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Queen Tribute</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Club Manhattan</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

            </section>
        
        </div>
    </main>

    <footer>
        <iframe src="../footer/footer.html" frameborder="0" scrolling="no" width="100%" height="auto"></iframe>
    </footer>

    <script>
        // Elementos de Perfil (source of truth)
        const profilePicture = document.querySelector('.profile-picture');
        const profileNameDisplay = document.querySelector('.profile-name');
        const profileEmailDisplay = document.getElementById('profile-email-display');
        const profilePhoneDisplay = document.getElementById('profile-phone-display');

        // Inputs do Formul√°rio
        const inputNome = document.getElementById('nome');
        const inputEmail = document.getElementById('email');
        const inputTelefone = document.getElementById('telefone');

        // Elementos de A√ß√£o
        const editProfileForm = document.querySelector('.edit-profile-form');
        const editPictureBtn = document.getElementById('edit-picture-btn');
        const pictureUploadInput = document.getElementById('picture-upload');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editProfileSection = document.getElementById('edit-profile-section');
        const listsSection = document.getElementById('lists-section'); // Adicionado
        const headerIframe = document.getElementById('site-header');

        // =========================================================
        // 1. üîë FUN√á√ÉO CRUCIAL: CARREGA DADOS DO LOCALSTORAGE
        // =========================================================
        function loadProfileData() {
            // Busca dados salvos no localStorage (vindos do login ou edi√ß√£o).
            const savedName = localStorage.getItem('profileName') || 'Nome de Exemplo';
            const savedEmail = localStorage.getItem('profileEmail') || 'exemplo@rol√™s.com';
            const savedPhone = localStorage.getItem('profilePhone') || '(62) 00000-0000';
            // Usa o placeholder padr√£o se n√£o houver foto salva
            const savedPhoto = localStorage.getItem('profilePhotoUrl') || "https://i.imgur.com/default-placeholder.png"; 

            // 1. Atualiza a exibi√ß√£o no cart√£o de perfil (DIV principal)
            profilePicture.src = savedPhoto;
            profileNameDisplay.textContent = savedName;
            profileEmailDisplay.textContent = savedEmail;
            profilePhoneDisplay.textContent = savedPhone;

            // 2. Atualiza os inputs do formul√°rio de edi√ß√£o para que a edi√ß√£o funcione sobre o dado correto
            inputNome.value = savedName;
            inputEmail.value = savedEmail;
            inputTelefone.value = savedPhone;
        }


        // =========================================================
        // 2. ‚¨ÜÔ∏è FUN√á√ÉO CRUCIAL: ATUALIZA√á√ÉO E SALVAMENTO NO LOCALSTORAGE (usado ao editar)
        // =========================================================
        function updateProfileData(photoUrl, name, email, phone) {
            
            // üîë SALVA NO LOCALSTORAGE PARA PERSIST√äNCIA 
            localStorage.setItem('profilePhotoUrl', photoUrl);
            localStorage.setItem('profileName', name);
            localStorage.setItem('profileEmail', email);
            localStorage.setItem('profilePhone', phone);

            // Usa postMessage para comunicar a atualiza√ß√£o ao Header Iframe
            if (headerIframe && headerIframe.contentWindow) {
                headerIframe.contentWindow.postMessage({
                    action: 'UPDATE_PROFILE_INFO',
                    newName: name,
                    newEmail: email,
                    newPicUrl: photoUrl 
                }, '*');
            }
        }
        
        // =========================================================
        // 3. üèÉ L√ìGICA DO DOMContentLoaded
        // =========================================================
        document.addEventListener('DOMContentLoaded', function () {
            
            // üö® CARREGA OS DADOS SALVOS DO LOCALSTORAGE ASSIM QUE A P√ÅGINA ABRE
            loadProfileData();

            // ------------------------------------------
            // L√ìGICA DE MOSTRAR/OCULTAR FORMUL√ÅRIO
            // ------------------------------------------
            editProfileBtn.addEventListener('click', function() {
                const isEditing = editProfileSection.classList.toggle('hidden');
                listsSection.classList.toggle('hidden', !isEditing); // Oculta a lista quando edita

                if (!isEditing) {
                    editProfileBtn.textContent = 'Cancelar Edi√ß√£o';
                } else {
                    editProfileBtn.textContent = 'Editar Perfil';
                }
            });

            cancelEditBtn.addEventListener('click', function() {
                editProfileSection.classList.add('hidden');
                listsSection.classList.remove('hidden'); 
                editProfileBtn.textContent = 'Editar Perfil';
            });
            // ------------------------------------------

            // ------------------------------------------
            // L√ìGICA DO BOT√ÉO SAIR (LOGOUT)
            // ------------------------------------------
            const logoutBtn = document.querySelector('.logout-btn');
            logoutBtn.addEventListener('click', function () {
                
                // Limpa as credenciais do usu√°rio do localStorage
                localStorage.removeItem('profilePhotoUrl');
                localStorage.removeItem('profileName');
                localStorage.removeItem('profileEmail');
                localStorage.removeItem('profilePhone');
                localStorage.removeItem('userIsLoggedIn');
                localStorage.removeItem('userType');
                
                // ENVIA COMANDO DE LOGOUT PARA O HEADER
                if (headerIframe && headerIframe.contentWindow) {
                    headerIframe.contentWindow.postMessage({
                        action: 'LOGOUT_REQUEST'
                    }, '*');
                }

                // Redireciona o usu√°rio para a p√°gina de logout
                window.location.href = '../login/logout-usuario.html';
            });
            // ------------------------------------------
            
            
            // L√≥gica de Edi√ß√£o de Imagem de Perfil (MANTIDA)
            editPictureBtn.addEventListener('click', function () {
                pictureUploadInput.click();
            });

            // Pr√©-visualiza e define a nova imagem de perfil
            pictureUploadInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        profilePicture.src = e.target.result;
                        // Salva a nova imagem e os dados atuais
                        updateProfileData(e.target.result, inputNome.value, inputEmail.value, inputTelefone.value); 
                        // ‚ùå N√£o h√° alert aqui, pois a atualiza√ß√£o √© visual e imediata (apenas a foto)
                    }
                    reader.readAsDataURL(file);
                }
            });

            // L√≥gica para Atualizar Dados do Perfil ao Salvar (SUBMIT DO FORM)
            editProfileForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const novoNome = inputNome.value;
                const novoEmail = inputEmail.value;
                const novoTelefone = inputTelefone.value;
                const novoSenha = document.getElementById('senha').value;

                // ** Valida√ß√£o: Verifica se o Nome e Email foram preenchidos **
                if (!novoNome.trim() || !novoEmail.trim()) {
                    alert('‚ö†Ô∏è Nome e Email s√£o campos obrigat√≥rios e devem ser preenchidos!');
                    return; 
                }
                
                // Valida√ß√£o de telefone (exemplo simples, mantendo a regra de formato de caracter)
                // Se houver valida√ß√£o de caracteres (como no seu pedido original de conter X caracteres) voc√™ adicionaria aqui.
                // Exemplo:
                // if (novoNome.length < 3) {
                //     alert('‚ö†Ô∏è O nome deve conter no m√≠nimo 3 caracteres.');
                //     return;
                // }


                // Salva no localStorage e envia a notifica√ß√£o ao Header
                updateProfileData(profilePicture.src, novoNome, novoEmail, novoTelefone);

                // Recarrega a exibi√ß√£o do perfil com os dados rec√©m-salvos
                loadProfileData(); 

                // Oculta o formul√°rio ap√≥s salvar
                editProfileSection.classList.add('hidden');
                listsSection.classList.remove('hidden');
                editProfileBtn.textContent = 'Editar Perfil';

                // ‚ùå REMOVIDO: alert('Perfil atualizado com sucesso!');
            });
        });
    </script>
</body>

</html>