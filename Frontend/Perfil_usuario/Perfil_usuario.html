<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usu√°rio</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/Perfil_usuario.css">
</head>

<body>
    <header>
        <iframe id="site-header" src="../header/header.html" frameborder="0" scrolling="no" width="100%" height="200"
            style="position: fixed; top: 0; left: 0; z-index: 999999999;"></iframe>
    </header>

    <main class="profile-container">

        <div class="main-profile-card">

            <aside class="profile-sidebar">

                <div class="profile-info-content">

                    <div class="profile-picture-container">
                        <img src="https://i.imgur.com/default-placeholder.png" alt="Foto de Perfil"
                            class="profile-picture">
                        <button id="edit-picture-btn" class="edit-picture-btn" title="Editar Foto de Perfil">
                            <i class="fas fa-camera"></i>
                        </button>
                        <input type="file" id="picture-upload" accept="image/*" style="display: none;">
                    </div>

                    <h2 class="profile-name"></h2>
                    <span class="profile-badge">Cliente</span>

                    <p class="profile-detail" id="profile-email-display"></p>
                    <p class="profile-detail" id="profile-phone-display">(62) 99999-9999</p>
                    <p class="profile-detail">Goi√¢nia - GO</p>
                    <p class="profile-detail member-since">Membro desde Jan 2026</p>

                    <button id="edit-profile-btn" class="action-btn edit-btn">Editar Perfil</button>
                    <button id="view-tickets-btn" class="action-btn tickets-btn">Ver Meus Ingressos</button>
                    <button class="action-btn logout-btn">Sair</button>
                </div>

            </aside>

            <section class="profile-content">

                <div id="edit-profile-section" class="content-section edit-profile-form-container hidden">
                    <h3>Editar Perfil</h3>
                    <form class="edit-profile-form" id="editProfileForm">
                        <div class="form-group">
                            <label for="nome">Nome</label>
                            <input type="text" id="nome" value="">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" value="">
                        </div>
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="tel" id="telefone" value="(62) 99999-9999">
                        </div>
                        <div class="form-group">
                            <label for="senha">Senha</label>
                            <input type="password" id="senha" value="********">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="save-btn">Salvar</button>
                            <button type="button" id="cancel-edit-btn" class="cancel-btn">Cancelar</button>
                        </div>
                    </form>
                </div>

                <div id="lists-section" class="content-sections-wrapper">

                    <div class="content-section favorites-list">
                        <h3><i class="fas fa-heart"></i> Lugares Favoritos</h3>
                        <ul class="place-list">
                            <li class="place-item">
                                <span class="place-name">Bar do Jo√£o</span>
                                <span class="place-category">Bar</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.6
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Restaurante Villa</span>
                                <span class="place-category">Restaurante</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.8
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Club Manhattan</span>
                                <span class="place-category">Restaurante</span>
                                <div class="place-rating">
                                    <i class="fas fa-star"></i> 4.9
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="content-section recent-visits-list">
                        <h3>Visitas Recentes</h3>
                        <ul class="place-list">
                            <li class="place-item">
                                <span class="place-name">Pizzaria Bella</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Queen Tribute</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                            <li class="place-item">
                                <span class="place-name">Club Manhattan</span>
                                <div class="place-rating-stars">
                                    <i class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star filled"></i><i class="fas fa-star filled"></i><i
                                        class="fas fa-star empty"></i>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div id="tickets-section" class="content-section tickets-section hidden">
                        <h3>Meus Ingressos</h3>
                        <ul class="ticket-list">
                            <li class="ticket-item">
                                <span class="ticket-name">Show BTS - Setor A</span>
                                <div class="ticket-actions">
                                    <button class="ticket-btn">Baixar</button>
                                    <button class="ticket-btn">Transferir</button>
                                </div>
                            </li>
                            <li class="ticket-item">
                                <span class="ticket-name">Festival Rock - Setor B</span>
                                <div class="ticket-actions">
                                    <button class="ticket-btn">Baixar</button>
                                    <button class="ticket-btn">Transferir</button>
                                </div>
                            </li>
                        </ul>
                    </div>



                </div>

            </section>

        </div>
    </main>

    <footer>
        <iframe src="../footer/footer.html" frameborder="0" scrolling="no" width="100%" height="auto"></iframe>
    </footer>

    <script>
        // Elementos de Perfil
        const profilePicture = document.querySelector('.profile-picture');
        const profileNameDisplay = document.querySelector('.profile-name');
        const profileEmailDisplay = document.getElementById('profile-email-display');
        const profilePhoneDisplay = document.getElementById('profile-phone-display');

        const inputNome = document.getElementById('nome');
        const inputEmail = document.getElementById('email');
        const inputTelefone = document.getElementById('telefone');

        const editProfileForm = document.querySelector('.edit-profile-form');
        const editPictureBtn = document.getElementById('edit-picture-btn');
        const pictureUploadInput = document.getElementById('picture-upload');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editProfileSection = document.getElementById('edit-profile-section');
        const listsSection = document.getElementById('lists-section');
        const headerIframe = document.getElementById('site-header');

        const viewTicketsBtn = document.getElementById('view-tickets-btn');
        const ticketsSection = document.getElementById('tickets-section');

        // Fun√ß√£o para atualizar dados locais e no header
        function updateProfileData(photoUrl, name, email, phone) {
            localStorage.setItem('profilePhotoUrl', photoUrl);
            localStorage.setItem('profileName', name);
            localStorage.setItem('profileEmail', email);
            localStorage.setItem('profilePhone', phone);

            if (headerIframe && headerIframe.contentWindow) {
                headerIframe.contentWindow.postMessage({
                    action: 'UPDATE_PROFILE_INFO',
                    newName: name,
                    newEmail: email,
                    newPicUrl: photoUrl
                }, '*');
            }
        }

        // Fun√ß√£o para carregar dados do backend usando userId
        async function loadProfileData() {
            const userId = localStorage.getItem('userId'); // üîπ Pega o ID salvo no login
            if (!userId) {
                alert("‚ùå Usu√°rio n√£o logado. Redirecionando para login...");
                window.location.href = "../login/login.html";
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/usuarios/${userId}`);
                if (!response.ok) throw new Error("Erro ao buscar dados do usu√°rio");

                const data = await response.json();

                // Atualizar na tela
                profileNameDisplay.textContent = data.nome_completo || "Cliente Rol√™s";
                profileEmailDisplay.textContent = data.email || "exemplo@roles.com";
                profilePhoneDisplay.textContent = data.telefone || "(62) 00000-0000";
                profilePicture.src = data.foto_perfil || "https://i.imgur.com/default-placeholder.png";

                // Atualizar inputs do formul√°rio
                inputNome.value = data.nome_completo || "";
                inputEmail.value = data.email || "";
                inputTelefone.value = data.telefone || "";

                // Atualizar localStorage
                updateProfileData(profilePicture.src, inputNome.value, inputEmail.value, inputTelefone.value);

            } catch (err) {
                console.error(err);
                alert("‚ùå N√£o foi poss√≠vel carregar os dados do perfil. Verifique o backend.");
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadProfileData();

            editProfileBtn.addEventListener('click', function () {
                const isEditing = editProfileSection.classList.toggle('hidden');
                listsSection.classList.toggle('hidden', !isEditing);
                editProfileBtn.textContent = isEditing ? 'Cancelar Edi√ß√£o' : 'Editar Perfil';
            });

            cancelEditBtn.addEventListener('click', function () {
                editProfileSection.classList.add('hidden');
                listsSection.classList.remove('hidden');
                editProfileBtn.textContent = 'Editar Perfil';
            });

            const logoutBtn = document.querySelector('.logout-btn');
            logoutBtn.addEventListener('click', function () {
                localStorage.clear();
                if (headerIframe && headerIframe.contentWindow) {
                    headerIframe.contentWindow.postMessage({ action: 'LOGOUT_REQUEST' }, '*');
                }
                window.location.href = '../login/login.html';
            });

            editPictureBtn.addEventListener('click', function () {
                pictureUploadInput.click();
            });

            pictureUploadInput.addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        profilePicture.src = e.target.result;
                        updateProfileData(e.target.result, inputNome.value, inputEmail.value, inputTelefone.value);
                    }
                    reader.readAsDataURL(file);
                }
            });

            editProfileForm.addEventListener('submit', async function (event) {
                event.preventDefault();

                const novoNome = inputNome.value.trim();
                const novoEmail = inputEmail.value.trim();
                const novoTelefone = inputTelefone.value.trim();

                if (!novoNome || !novoEmail) {
                    alert('‚ö†Ô∏è Nome e Email s√£o obrigat√≥rios!');
                    return;
                }

                const userId = localStorage.getItem('userId');

                try {
                    const response = await fetch(`http://localhost:3000/usuarios/perfil`, { // üîπ Endpoint que aceita PUT
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            id: userId, // üîπ Adicionado para garantir que o backend saiba qual atualizar
                            nome_completo: novoNome,
                            email: novoEmail,
                            telefone: novoTelefone,
                            foto_perfil: profilePicture.src
                        })
                    });

                    if (!response.ok) throw new Error("Erro ao atualizar perfil");

                    updateProfileData(profilePicture.src, novoNome, novoEmail, novoTelefone);
                    alert("‚úÖ Perfil atualizado com sucesso!");
                    loadProfileData();
                    editProfileSection.classList.add('hidden');
                    listsSection.classList.remove('hidden');
                    editProfileBtn.textContent = 'Editar Perfil';

                } catch (err) {
                    console.error(err);
                    alert("‚ùå Falha ao atualizar perfil. Verifique o backend.");
                }
            });

            viewTicketsBtn.addEventListener('click', function () {
                ticketsSection.classList.toggle('hidden');
                ticketsSection.scrollIntoView({ behavior: "smooth" });
            });
        });


    </script>
</body>

</html>