<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Header Rol√™s</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="../css/header.css">

    <base href="../" target="_top">

    <style>
        .logo a {
            font-family: 'Poppins', sans-serif;
            font-size: 20px;
            font-weight: 700;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="index.html">Rol√™s</a>
            </div>

            <ul class="menu">

                <div id="menu-cliente" style="display: none; display: flex; gap: 30px;">
                    <li><a href="index.html">In√≠cio</a></li>
                    <li><a href="locais/locais.html">Locais</a></li>
                    <li><a href="Eventos/eventos.html">Eventos</a></li>
                    <li><a href="Para empresarios/empresario.html">Para Empres√°rios</a></li>
                    <li><a href="quem somos/quemsomos.html">Quem Somos</a></li>
                    <li><a href="Contato/contato.html">Contato</a></li>
                </div>

                <div id="menu-empresario" style="display: none; display: flex; gap: 30px;">
                    <li><a href="Empresario/dashboard.html">Dashboard</a></li>
                    <li><a href="Para empresarios/empresario.html">Para Empres√°rios</a></li>
                    <li><a href="quem somos/quemsomos.html">Quem Somos</a></li>
                    <li><a href="Contato/contato.html">Contato</a></li>
                </div>
            </ul>

            <div class="right-section">

                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar locais...">
                </div>

                <button class="city-btn">
                    <i class="fas fa-map-marker-alt"></i> Goi√¢nia
                </button>

                <div id="header-nao-logado" class="user-action-btns">
                    <a href="login/login.html" class="login">Entrar</a>
                    <a href="Cadastro/cadastro.html" class="btn-header-cadastro">Cadastrar</a>
                </div>

                <div id="header-logado" class="user-profile-container" style="display: none;">
                    <div class="profile-avatar">
                        <img id="profile-pic-header" src="https://i.imgur.com/default-placeholder.png"
                            alt="Foto de Perfil" class="avatar-img">
                    </div>

                    <div class="dropdown-menu">
                        <div class="user-info">
                            <strong>Nome do Estabelecimento</strong>
                            <span>email@empresa.com</span>
                        </div>

                        <a href="#" id="edit-profile-link" class="dropdown-item">
                            <i class="fas fa-user"></i> Perfil
                        </a>

                        <a href="#" class="dropdown-item logout-btn">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </a>
                    </div>
                </div>

            </div>

        </nav>

        <div class="bottom-gradient-bar"></div>

        <div class="header-placeholder-fixo"></div>

        <main class="conteudo-principal-evento">
    </header>


    <script>
        // Seleciona os containers de menu
        const menuCliente = document.getElementById('menu-cliente');
        const menuEmpresario = document.getElementById('menu-empresario');

        // ----------------------------------------------------
        // FUN√á√ÉO: CARREGA DADOS SALVOS DO LOCALSTORAGE (CR√çTICO)
        // ----------------------------------------------------
        function loadPersistentData() {
            // üîë L√™ os dados salvos (agora salvos no login)
            const photoUrl = localStorage.getItem('profilePhotoUrl');
            const name = localStorage.getItem('profileName');
            const email = localStorage.getItem('profileEmail');

            const headerPicElement = document.getElementById('profile-pic-header');
            const dropdownName = document.querySelector('.dropdown-menu .user-info strong');
            const dropdownEmail = document.querySelector('.dropdown-menu .user-info span');

            // Atualiza Foto
            if (photoUrl && headerPicElement) {
                headerPicElement.src = photoUrl;
            } else if (headerPicElement) {
                // Placeholder padr√£o
                headerPicElement.src = "https://i.imgur.com/default-placeholder.png"; 
            }

            // üí° Atualiza Nome 
            if (name && dropdownName) {
                dropdownName.textContent = name;
            } else if (dropdownName) {
                dropdownName.textContent = 'Visitante'; // Fallback
            }

            // üí° Atualiza Email
            if (email && dropdownEmail) {
                dropdownEmail.textContent = email;
            } else if (dropdownEmail) {
                dropdownEmail.textContent = 'email@padrao.com'; // Fallback
            }
        }

        // ----------------------------------------------------
        // FUN√á√ÉO L√ìGICA DE LOGOUT 
        // ----------------------------------------------------
        function setupLogoutListener() {
            const logoutBtn = document.querySelector('.logout-btn');

            if (logoutBtn && !logoutBtn.dataset.listenerAdded) {

                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();

                    const userType = localStorage.getItem('userType');

                    // Limpa as chaves de persist√™ncia
                    localStorage.removeItem('userIsLoggedIn');
                    localStorage.removeItem('userType');
                    localStorage.removeItem('profilePhotoUrl');
                    localStorage.removeItem('profileName');
                    localStorage.removeItem('profileEmail');

                    // ‚ùå REMOVIDO: alert('Logout realizado com sucesso!');

                    let logoutPath;
                    if (userType === 'empresario') {
                        logoutPath = 'login/logout-empresario.html'; 
                    } else { 
                        logoutPath = 'login/logout-usuario.html'; 
                    }

                    alternarEstadoHeader(false, 'cliente');

                    // Redireciona a p√°gina principal (o pai do iframe)
                    window.parent.location.href = logoutPath;
                });

                logoutBtn.dataset.listenerAdded = 'true';
            }
        }


        // FUN√á√ÉO PRINCIPAL: Controla o estado, o menu e os links de Perfil (MANTIDA)
        function alternarEstadoHeader(logado, userType = 'cliente') {
            const naoLogado = document.getElementById('header-nao-logado');
            const logadoDiv = document.getElementById('header-logado');
            const editProfileLink = document.getElementById('edit-profile-link');

            if (logado) {
                naoLogado.style.display = 'none';
                logadoDiv.style.display = 'flex';

                if (userType === 'empresario') {
                    menuCliente.style.display = 'none';
                    menuEmpresario.style.display = 'flex';
                } else { 
                    menuCliente.style.display = 'flex';
                    menuEmpresario.style.display = 'none';
                }

                if (editProfileLink) {
                    if (userType === 'empresario') {
                        // Link correto para o perfil do empres√°rio
                        editProfileLink.href = 'Perfil_empresario/Perfil_empresario.html';
                    } else { 
                        // Link correto para o perfil do usu√°rio
                        editProfileLink.href = 'Perfil_usuario/perfil_usuario.html';
                    }
                }

                setupLogoutListener();

            } else {
                naoLogado.style.display = 'flex';
                logadoDiv.style.display = 'none';

                menuCliente.style.display = 'flex';
                menuEmpresario.style.display = 'none';
            }
        }

        // ----------------------------------------------------
        // VERIFICA√á√ÉO INICIAL (MANTIDA)
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            loadPersistentData();

            const isLogged = localStorage.getItem('userIsLoggedIn');
            const userType = localStorage.getItem('userType') || 'cliente';

            if (isLogged === 'true') {
                alternarEstadoHeader(true, userType);
            } else {
                alternarEstadoHeader(false, userType);
            }
        });

        // ----------------------------------------------------
        // L√ìGICA DO DROPDOWN (AVATAR) (MANTIDA)
        // ----------------------------------------------------
        const profileContainer = document.querySelector('.user-profile-container');
        if (profileContainer) {
            profileContainer.addEventListener('click', () => {
                profileContainer.classList.toggle('active');
            });
        }

        // ----------------------------------------------------
        // COMUNICA√á√ÉO COM O IFRAME (postMessage) - RECEBE ATUALIZA√á√ïES
        // ----------------------------------------------------
        window.addEventListener('message', (event) => {
            const data = event.data;
            const headerPic = document.getElementById('profile-pic-header');
            const dropdownName = document.querySelector('.dropdown-menu .user-info strong');
            const dropdownEmail = document.querySelector('.dropdown-menu .user-info span');

            // A√ß√£o de login de empres√°rio vinda do cadastro_empresario.html (MANTIDA)
            if (data && data.action === 'LOGIN_SUCCESS_EMPRESARIO') {
                alternarEstadoHeader(true, 'empresario');
                loadPersistentData(); 
            } 
            // üí° NOVO: A√ß√£o de login de usu√°rio vinda do login.html
            else if (data && data.action === 'LOGIN_SUCCESS') { 
                const userType = data.userType || 'cliente';

                // üîë Salva os dados frescos (Nome Padr√£o e Email real) do login no localStorage
                if (data.newName) localStorage.setItem('profileName', data.newName);
                if (data.newEmail) localStorage.setItem('profileEmail', data.newEmail);
                
                alternarEstadoHeader(true, userType);
                loadPersistentData(); // Recarrega com os novos dados
            } 
            
            // Recebe a atualiza√ß√£o de FOTO + INFO (do perfil) (MANTIDA)
            else if (data && data.action === 'UPDATE_PROFILE_INFO' && data.newPicUrl) {
                
                if (headerPic) headerPic.src = data.newPicUrl;
                if (data.newName && dropdownName) dropdownName.textContent = data.newName;
                if (data.newEmail && dropdownEmail) dropdownEmail.textContent = data.newEmail;
                
                localStorage.setItem('profilePhotoUrl', data.newPicUrl);
            }

            // Recebe atualiza√ß√£o de NOME e EMAIL (do bot√£o Salvar) (MANTIDA)
            else if (data && data.action === 'UPDATE_PROFILE_INFO' && data.newName && data.newEmail) {
                
                if (dropdownName) dropdownName.textContent = data.newName;
                if (dropdownEmail) dropdownEmail.textContent = data.newEmail;
                
                localStorage.setItem('profileName', data.newName); 
                localStorage.setItem('profileEmail', data.newEmail);
            }
            
            // Recebe o comando de logout (MANTIDA)
            else if (data && data.action === 'LOGOUT_REQUEST') {
                
                localStorage.removeItem('profilePhotoUrl');
                localStorage.removeItem('profileName');
                localStorage.removeItem('profileEmail');
                localStorage.removeItem('userIsLoggedIn');
                localStorage.removeItem('userType');

                alternarEstadoHeader(false, 'cliente'); 
            }
        });
    </script>
</body>

</html>